name: Stock Alert Bot

on:
  schedule:
    # Runs every 5 minutes between 10:00am and 3:00pm PT (17:00-23:00 UTC) on weekdays
    # PT is UTC-8 (PST) or UTC-7 (PDT), so 10am-3pm PT = 17:00-23:00 UTC (PST) or 18:00-00:00 UTC (PDT)
    # Using 17:00-23:00 UTC covers both PST and PDT
    - cron: "*/5 17-23 * * 1-5"
  workflow_dispatch: # Allow manual triggering

jobs:
  alert:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Verify secrets
        run: |
          echo "Checking required secrets..."
          if [ -z "${{ secrets.TWELVE_DATA_API_KEY }}" ]; then echo "❌ TWELVE_DATA_API_KEY missing"; exit 1; fi
          if [ -z "${{ secrets.FMP_API_KEY }}" ]; then echo "❌ FMP_API_KEY missing"; exit 1; fi
          if [ -z "${{ secrets.DISCORD_BOT_TOKEN }}" ]; then echo "❌ DISCORD_BOT_TOKEN missing"; exit 1; fi
          if [ -z "${{ secrets.DISCORD_CHANNEL_ID }}" ]; then echo "❌ DISCORD_CHANNEL_ID missing"; exit 1; fi
          if [ -z "${{ secrets.GIST_ID }}" ]; then echo "❌ GIST_ID missing"; exit 1; fi
          if [ -z "${{ secrets.GH_PAT }}" ]; then echo "❌ GH_PAT missing"; exit 1; fi
          echo "✅ All required secrets present"
      
      - name: Run bot
        env:
          TWELVE_DATA_API_KEY: ${{ secrets.TWELVE_DATA_API_KEY }}
          FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          DISCORD_CHANNEL_ID: ${{ secrets.DISCORD_CHANNEL_ID }}
          GIST_ID: ${{ secrets.GIST_ID }}
          GH_PAT: ${{ secrets.GH_PAT }}
          ALERT_THRESHOLD_PCT: ${{ secrets.ALERT_THRESHOLD_PCT || '90' }}
          HAIRCUT_RATE: ${{ secrets.HAIRCUT_RATE || '0.125' }}
        run: |
          python bot.py
